<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Finger Counter</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #0f172a;
        --panel: #111827;
        --text: #e5e7eb;
        --accent: #22c55e;
        --muted: #94a3b8;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: radial-gradient(1200px 600px at 50% -10%, #1f2937, var(--bg));
        color: var(--text);
        min-height: 100vh;
        display: grid;
        place-items: center;
      }
      .app {
        width: min(980px, 92vw);
        display: grid;
        gap: 16px;
      }
      .panel {
        background: color-mix(in srgb, var(--panel) 80%, #000);
        border: 1px solid #1f2937;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      }
      .status {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .count {
        font-size: clamp(28px, 5vw, 44px);
        font-weight: 700;
        color: var(--accent);
      }
      .muted { color: var(--muted); }
      .stage {
        position: relative;
        aspect-ratio: 16/9;
        overflow: hidden;
        border-radius: 12px;
        background: #0b1220;
      }
      video, canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .log {
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        font-size: 13px;
        white-space: pre-wrap;
      }
      button {
        background: #1f2937;
        color: var(--text);
        border: 1px solid #374151;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      button:hover { border-color: #4b5563; }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="panel status">
        <div>
          <div class="muted">Fingers up</div>
          <div id="count" class="count">0</div>
        </div>
        <div class="muted" id="state">Initializing camera…</div>
        <button id="toggle">Pause</button>
      </div>

      <div class="panel stage">
        <video id="video" playsinline></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="panel log" id="log">Waiting for hand landmarks…</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <script>
      const video = document.getElementById('video');
      const canvas = document.getElementById('overlay');
      const ctx = canvas.getContext('2d');
      const countEl = document.getElementById('count');
      const logEl = document.getElementById('log');
      const stateEl = document.getElementById('state');
      const toggleBtn = document.getElementById('toggle');

      let running = true;
      let lastCount = 0;

      function resizeCanvas() {
        const { width, height } = video.getBoundingClientRect();
        if (width && height) {
          canvas.width = width;
          canvas.height = height;
        }
      }
      window.addEventListener('resize', resizeCanvas);

      function countFingers(landmarks, handedness) {
        const tips = [4, 8, 12, 16, 20];
        const pips = [3, 6, 10, 14, 18];
        let count = 0;

        // Thumb uses x-axis, depends on handedness
        const thumbTip = landmarks[tips[0]];
        const thumbIp = landmarks[pips[0]];
        if (handedness === 'Right') {
          if (thumbTip.x > thumbIp.x) count += 1;
        } else {
          if (thumbTip.x < thumbIp.x) count += 1;
        }

        // Other four fingers use y-axis (tip above pip)
        for (let i = 1; i < tips.length; i++) {
          const tip = landmarks[tips[i]];
          const pip = landmarks[pips[i]];
          if (tip.y < pip.y) count += 1;
        }
        return count;
      }

      const hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
      });

      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.6,
        selfieMode: true
      });

      hands.onResults((results) => {
        resizeCanvas();
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        let total = 0;
        if (results.multiHandLandmarks && results.multiHandedness) {
          results.multiHandLandmarks.forEach((landmarks, i) => {
            const label = results.multiHandedness[i].label;
            total += countFingers(landmarks, label);
            drawConnectors(ctx, landmarks, HAND_CONNECTIONS, { color: '#22c55e', lineWidth: 3 });
            drawLandmarks(ctx, landmarks, { color: '#93c5fd', lineWidth: 1 });
          });
        }

        ctx.restore();

        if (total !== lastCount) {
          lastCount = total;
          countEl.textContent = String(total);
          logEl.textContent = `Detected fingers: ${total}`;
        }
        stateEl.textContent = results.multiHandLandmarks && results.multiHandLandmarks.length
          ? 'Tracking hands'
          : 'No hands detected';
      });

      const camera = new Camera(video, {
        onFrame: async () => {
          if (!running) return;
          await hands.send({ image: video });
        },
        width: 1280,
        height: 720
      });

      toggleBtn.addEventListener('click', () => {
        running = !running;
        toggleBtn.textContent = running ? 'Pause' : 'Resume';
        if (running) {
          stateEl.textContent = 'Resuming…';
        } else {
          stateEl.textContent = 'Paused';
        }
      });

      camera.start()
        .then(() => { stateEl.textContent = 'Camera ready'; })
        .catch((err) => {
          console.error(err);
          stateEl.textContent = 'Camera access denied or unavailable';
          logEl.textContent = String(err);
        });
    </script>
  </body>
</html>
